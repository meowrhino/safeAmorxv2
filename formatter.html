<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Safe Amorx ¬∑ editor de contenido</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Archivo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ============================================================================
       ESTILOS (versi√≥n compacta)
       ============================================================================ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --color-bg: #f7f3ec;
      --color-surface: #ffffff;
      --color-border: #e4dcd3;
      --color-text: #1d1511;
      --color-muted: #6f6259;
      --color-strong: #0f0c0a;
      --color-soft: #fcfaf7;
      --radius: 12px;
      --shadow: 0 12px 32px rgba(0, 0, 0, 0.05);
      --font-main: 'Archivo', sans-serif;
    }
    body { font-family: var(--font-main); background: var(--color-bg); color: var(--color-text); min-height: 100vh; line-height: 1.5; }
    .formatter-header { display: flex; align-items: flex-end; justify-content: space-between; gap: 12px; padding: 28px 32px 18px; border-bottom: 1px solid var(--color-border); background: var(--color-bg); }
    .title-block h1 { font-size: 1.8rem; letter-spacing: -0.02em; font-weight: 600; color: var(--color-strong); }
    .eyebrow { text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.85rem; color: var(--color-muted); margin-bottom: 4px; }
    .tabs { display: flex; gap: 8px; padding: 0 32px 16px; border-bottom: 1px solid var(--color-border); background: var(--color-bg); }
    .tab { background: transparent; border: none; padding: 10px 14px; cursor: pointer; color: var(--color-muted); border-bottom: 2px solid transparent; font-size: 1rem; text-transform: lowercase; display: inline-flex; align-items: center; gap: 8px; transition: color 0.2s ease, border-color 0.2s ease; }
    .tab:hover { color: var(--color-text); }
    .tab.active { color: var(--color-text); border-bottom-color: var(--color-strong); }
    .tab-count { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 999px; padding: 2px 8px; font-size: 0.85rem; color: var(--color-muted); }
    .formatter-main { display: grid; grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr); gap: 24px; padding: 24px 32px 32px; }
    .editor-panel, .preview-panel { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius); display: flex; flex-direction: column; box-shadow: var(--shadow); }
    .panel-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; padding: 18px 20px 12px; border-bottom: 1px solid var(--color-border); }
    .panel-header h2 { font-size: 1.25rem; font-weight: 600; letter-spacing: -0.01em; margin-top: 2px; }
    .panel-actions { display: flex; gap: 10px; align-items: center; }
    .sections-container, .preview-container { padding: 18px 20px 24px; overflow-y: auto; }
    .section-card { background: var(--color-soft); border: 1px solid var(--color-border); border-radius: 10px; padding: 16px; margin-bottom: 14px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .section-number { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--color-muted); }
    .section-actions { display: flex; gap: 8px; align-items: center; }
    .form-group { margin-bottom: 14px; }
    .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.95rem; color: var(--color-muted); }
    .form-label.optional::after { content: " (opcional)"; font-weight: 400; }
    .form-input, .form-textarea { width: 100%; border: 1px solid var(--color-border); border-radius: 10px; padding: 10px 12px; font-size: 1rem; font-family: var(--font-main); background: var(--color-surface); color: var(--color-text); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
    .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--color-strong); box-shadow: 0 0 0 2px rgba(15, 12, 10, 0.08); }
    .form-textarea { min-height: 80px; resize: vertical; }
    .paragraph-list, .logo-list { display: flex; flex-direction: column; gap: 10px; }
    .block-list { display: flex; flex-direction: column; gap: 12px; }
    .block-card { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 10px; padding: 12px; }
    .block-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .block-label { font-size: 0.9rem; color: var(--color-muted); }
    .paragraph-item, .logo-item { background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 10px; padding: 12px; }
    .paragraph-header, .logo-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .paragraph-label, .logo-label { font-size: 0.9rem; color: var(--color-muted); }
    .logo-fields { display: flex; flex-direction: column; gap: 10px; }
    .btn { border: 1px solid var(--color-border); background: var(--color-surface); color: var(--color-text); border-radius: 10px; padding: 10px 14px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background 0.2s ease, transform 0.2s ease, border-color 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; text-decoration: none; }
    .btn:hover { background: #f0ebe4; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }
    .btn:disabled:hover { background: var(--color-surface); }
    .btn.solid { background: var(--color-strong); color: #ffffff; border-color: var(--color-strong); }
    .btn.solid:hover { background: #0c0907; }
    .btn.ghost { background: transparent; }
    .btn-small { padding: 8px 12px; font-size: 0.95rem; }
    .btn-icon { padding: 6px 10px; }
    .btn-add { width: 100%; border-style: dashed; color: var(--color-muted); background: transparent; }
    .btn-add:hover { background: #f0ebe4; color: var(--color-text); }
    .btn-danger { border-color: #d33643; color: #d33643; }
    .btn-danger:hover { background: rgba(211, 54, 67, 0.08); }
    .preview-container { background: var(--color-surface); }
    .preview-section { padding-bottom: 18px; margin-bottom: 18px; border-bottom: 1px solid var(--color-border); }
    .preview-section:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .preview-section h2 { font-size: 1.4rem; font-weight: 600; letter-spacing: -0.01em; margin-bottom: 4px; }
    .preview-section h3 { font-size: 1.05rem; font-weight: 600; color: var(--color-muted); margin-bottom: 8px; }
    .preview-section p { color: var(--color-text); margin-bottom: 10px; }
    .preview-logos { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .preview-logo { border: 1px solid var(--color-border); border-radius: 8px; padding: 6px 10px; background: var(--color-soft); color: var(--color-muted); font-size: 0.95rem; }
    .formatter-footer { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 12px; padding: 16px 32px 28px; border-top: 1px solid var(--color-border); background: var(--color-bg); }
    .footer-actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .footer-actions.footer-left { justify-content: flex-start; }
    .footer-actions.footer-center { justify-content: center; }
    .status-message { min-height: 1.2em; color: var(--color-muted); justify-self: end; }
    .status-message.success { color: #1f7a4c; }
    .status-message.error { color: #c0392b; }
    .status-message.warning { color: #c28418; }
    .empty-state { text-align: center; color: var(--color-muted); padding: 18px; background: var(--color-soft); border: 1px dashed var(--color-border); border-radius: 10px; }
    .sections-container::-webkit-scrollbar, .preview-container::-webkit-scrollbar { width: 8px; }
    .sections-container::-webkit-scrollbar-thumb, .preview-container::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 10px; }
    .sections-container::-webkit-scrollbar-track, .preview-container::-webkit-scrollbar-track { background: transparent; }
    @media (max-width: 1024px) { .formatter-main { grid-template-columns: 1fr; } .preview-panel { order: 2; } }
    @media (max-width: 768px) {
      .formatter-header, .formatter-footer { padding-left: 20px; padding-right: 20px; }
      .tabs { padding: 0 20px 14px; }
      .formatter-main { padding: 20px; gap: 18px; }
      .panel-header { flex-direction: column; align-items: flex-start; }
      .formatter-footer { grid-template-columns: 1fr; justify-items: center; }
      .footer-actions.footer-left,
      .footer-actions.footer-center { justify-content: center; }
      .status-message { justify-self: center; }
    }
  </style>
</head>
<body>
  <header class="formatter-header">
    <div class="title-block">
      <p class="eyebrow">safe amorx</p>
      <h1>editor de contenido</h1>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" data-category="about">about <span class="tab-count" id="count-about">0</span></button>
    <button class="tab" data-category="booking">booking <span class="tab-count" id="count-booking">0</span></button>
    <button class="tab" data-category="cv">cv <span class="tab-count" id="count-cv">0</span></button>
  </nav>

  <main class="formatter-main">
    <section class="editor-panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">categor√≠a</p>
          <h2 id="categoryTitle">About</h2>
        </div>
        <button id="addSectionBtn" class="btn solid">+ a√±adir secci√≥n</button>
      </div>
      <div id="sectionsContainer" class="sections-container"></div>
    </section>

    <section class="preview-panel">
      <div class="panel-header">
        <div>
          <p class="eyebrow">vista previa</p>
          <h2>Contenido</h2>
        </div>
      </div>
      <div id="previewContainer" class="preview-container"></div>
    </section>
  </main>

  <footer class="formatter-footer">
    <div class="footer-actions footer-left">
      <button id="saveBtn" class="btn ghost">Guardar local</button>
    </div>
    <div class="footer-actions footer-center">
      <button id="copyJsonBtn" class="btn ghost">Copiar JSON</button>
      <button id="downloadBtn" class="btn solid">Descargar data.json</button>
    </div>
    <span class="status-message" id="statusMessage"></span>
  </footer>

  <script>
    // ============================================================================
    // storage.js (embebido)
    // ============================================================================
    const Storage = {
      STORAGE_KEY: 'safeamorx_content_data',

      save(data) {
        try {
          localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
          return true;
        } catch (error) {
          console.error('Error al guardar en LocalStorage:', error);
          return false;
        }
      },

      load() {
        try {
          const data = localStorage.getItem(this.STORAGE_KEY);
          const parsed = data ? JSON.parse(data) : null;
          return this.normalize(parsed);
        } catch (error) {
          console.error('Error al cargar desde LocalStorage:', error);
          return null;
        }
      },

      clear() {
        try {
          localStorage.removeItem(this.STORAGE_KEY);
          return true;
        } catch (error) {
          console.error('Error al limpiar LocalStorage:', error);
          return false;
        }
      },

      export(data, filename = 'data.json') {
        try {
          const jsonString = JSON.stringify(data, null, 2);
          const blob = new Blob([jsonString], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          return true;
        } catch (error) {
          console.error('Error al exportar JSON:', error);
          return false;
        }
      },

      import(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const parsed = JSON.parse(event.target.result);
              const normalized = this.normalize(parsed);
              if (!normalized || !this.validate(normalized)) {
                reject(new Error('El archivo JSON no tiene la estructura correcta'));
                return;
              }
              resolve(normalized);
            } catch (error) {
              reject(new Error('Error al parsear el archivo JSON: ' + error.message));
            }
          };
          reader.onerror = () => reject(new Error('Error al leer el archivo'));
          reader.readAsText(file);
        });
      },

      validate(data) {
        const normalized = this.normalize(data);
        if (!normalized) return false;
        return ['about', 'booking', 'cv'].every((category) => Array.isArray(normalized[category]));
      },

      getEmptyStructure() {
        return { about: [], booking: [], cv: [] };
      },

      async copyToClipboard(data) {
        try {
          const jsonString = JSON.stringify(data, null, 2);
          await navigator.clipboard.writeText(jsonString);
          return true;
        } catch (error) {
          console.error('Error al copiar al portapapeles:', error);
          return false;
        }
      },

      normalize(raw) {
        if (!raw || typeof raw !== 'object') return null;
        const data = JSON.parse(JSON.stringify(raw));
        if (!data.cv && Array.isArray(data.curriculum)) {
          data.cv = data.curriculum;
          delete data.curriculum;
        }
        const normalizeSection = (section) => {
          if (!section || typeof section !== 'object') {
            return { titulo: '', bloques: [{ subtitulo: '', texto: [] }] };
          }
          const normalized = { ...section };
          if (!Array.isArray(normalized.bloques)) {
            const subtitulo = typeof normalized.subtitulo === 'string' ? normalized.subtitulo : '';
            const texto = Array.isArray(normalized.texto) ? normalized.texto : [];
            normalized.bloques = [{ subtitulo, texto }];
            delete normalized.subtitulo;
            delete normalized.texto;
          } else {
            normalized.bloques = normalized.bloques.map(block => ({
              subtitulo: typeof block.subtitulo === 'string' ? block.subtitulo : '',
              texto: Array.isArray(block.texto) ? block.texto : []
            }));
          }
          return normalized;
        };
        ['about', 'booking', 'cv'].forEach((category) => {
          if (!Array.isArray(data[category])) data[category] = [];
          data[category] = data[category].map(normalizeSection);
        });
        return data;
      },

      async fetchFromRepo() {
        try {
          const response = await fetch('data.json', { cache: 'no-cache' });
          if (!response.ok) throw new Error(`Respuesta ${response.status}`);
          const json = await response.json();
          return this.normalize(json);
        } catch (error) {
          console.error('Error al cargar data.json del repo:', error);
          return null;
        }
      }
    };

    // ============================================================================
    // preview.js (embebido)
    // ============================================================================
    const Preview = {
      container: null,

      init() {
        this.container = document.getElementById('previewContainer');
      },

      render(categoryData) {
        if (!this.container) return;
        this.container.innerHTML = '';

        if (!categoryData || categoryData.length === 0) {
          this.container.innerHTML = '<p class="empty-state">No hay contenido para mostrar</p>';
          return;
        }

        categoryData.forEach((section, index) => {
          const sectionElement = this.createSectionPreview(section, index);
          this.container.appendChild(sectionElement);
        });
      },

      createSectionPreview(section) {
        const div = document.createElement('div');
        div.className = 'preview-section';

        if (section.titulo) {
          const h2 = document.createElement('h2');
          h2.textContent = section.titulo;
          div.appendChild(h2);
        }

        const blocks = this.normalizeBlocks(section);
        blocks.forEach(block => {
          if (block.subtitulo && block.subtitulo.trim()) {
            const h3 = document.createElement('h3');
            h3.textContent = block.subtitulo;
            div.appendChild(h3);
          }

          block.texto.forEach(parrafo => {
            if (typeof parrafo === 'string' && parrafo.trim()) {
              const p = document.createElement('p');
              p.textContent = parrafo;
              div.appendChild(p);
            }
          });
        });

        if (section.logos && Array.isArray(section.logos) && section.logos.length > 0) {
          const logosDiv = document.createElement('div');
          logosDiv.className = 'preview-logos';

          section.logos.forEach(logo => {
            if (logo.src) {
              const logoContainer = document.createElement('div');
              logoContainer.className = 'preview-logo';
              logoContainer.textContent = `üñºÔ∏è ${logo.alt || 'Logo'}`;
              logosDiv.appendChild(logoContainer);
            }
          });

          div.appendChild(logosDiv);
        }
        return div;
      },

      normalizeBlocks(section) {
        if (Array.isArray(section.bloques)) {
          return section.bloques.map(block => ({
            subtitulo: typeof block.subtitulo === 'string' ? block.subtitulo : '',
            texto: Array.isArray(block.texto)
              ? block.texto
              : (typeof block.texto === 'string' ? [block.texto] : [])
          }));
        }

        const subtitulo = typeof section.subtitulo === 'string' ? section.subtitulo : '';
        const texto = Array.isArray(section.texto)
          ? section.texto
          : (typeof section.texto === 'string' ? [section.texto] : []);

        return [{ subtitulo, texto }];
      },

      clear() {
        if (this.container) this.container.innerHTML = '';
      }
    };

    // ============================================================================
    // editor.js (embebido)
    // ============================================================================
    const Editor = {
      container: null,
      currentCategory: 'about',
      data: null,

      init(data) {
        this.container = document.getElementById('sectionsContainer');
        this.data = data || Storage.getEmptyStructure();
      },

      renderCategory(category) {
        this.currentCategory = category;
        this.container.innerHTML = '';
        const sections = this.data[category] || [];

        if (sections.length === 0) {
          this.container.innerHTML = '<p class="empty-state">No hay secciones. Pulsa "+ a√±adir secci√≥n" para empezar.</p>';
          return;
        }

        sections.forEach((section, index) => {
          const sectionCard = this.createSectionCard(section, index);
          this.container.appendChild(sectionCard);
        });
      },

      createSectionCard(section, index) {
        const card = document.createElement('div');
        card.className = 'section-card';
        card.dataset.index = index;

        const header = document.createElement('div');
        header.className = 'section-header';
        header.innerHTML = `
          <span class="section-number">Secci√≥n #${index + 1}</span>
          <div class="section-actions">
            <button class="btn btn-icon btn-small" onclick="Editor.moveSection(${index}, -1)" title="Mover arriba" ${index === 0 ? 'disabled' : ''}>‚Üë</button>
            <button class="btn btn-icon btn-small" onclick="Editor.moveSection(${index}, 1)" title="Mover abajo" ${index === this.data[this.currentCategory].length - 1 ? 'disabled' : ''}>‚Üì</button>
            <button class="btn btn-icon btn-small btn-danger" onclick="Editor.deleteSection(${index})" title="Eliminar secci√≥n">üóëÔ∏è</button>
          </div>
        `;
        card.appendChild(header);

        card.appendChild(this.createFormGroup('T√≠tulo (H2)', 'text', section.titulo || '', (value) => this.updateSection(index, 'titulo', value)));
        card.appendChild(this.createBlocksGroup(section, index));
        card.appendChild(this.createLogosGroup(section.logos || [], index));
        return card;
      },

      createFormGroup(label, type, value, onChange, optional = false) {
        const group = document.createElement('div');
        group.className = 'form-group';
        const labelEl = document.createElement('label');
        labelEl.className = 'form-label' + (optional ? ' optional' : '');
        labelEl.textContent = label;
        group.appendChild(labelEl);

        const input = document.createElement(type === 'textarea' ? 'textarea' : 'input');
        input.className = type === 'textarea' ? 'form-textarea' : 'form-input';
        if (type !== 'textarea') input.type = type;
        input.value = value;
        input.addEventListener('input', (e) => onChange(e.target.value));
        group.appendChild(input);
        return group;
      },

      createBlocksGroup(section, sectionIndex) {
        const blocks = this.normalizeBlocks(section);
        const group = document.createElement('div');
        group.className = 'form-group';
        const label = document.createElement('label');
        label.className = 'form-label optional';
        label.textContent = 'Bloques (H3 + p√°rrafos)';
        group.appendChild(label);

        const list = document.createElement('div');
        list.className = 'block-list';
        blocks.forEach((block, blockIndex) => {
          const item = this.createBlockCard(block, sectionIndex, blockIndex);
          list.appendChild(item);
        });
        group.appendChild(list);
        return group;
      },

      createBlockCard(block, sectionIndex, blockIndex) {
        const card = document.createElement('div');
        card.className = 'block-card';

        const header = document.createElement('div');
        header.className = 'block-header';
        header.innerHTML = `
          <span class="block-label">Bloque ${blockIndex + 1}</span>
          <button class="btn btn-icon btn-small" onclick="Editor.deleteBlock(${sectionIndex}, ${blockIndex})" title="Eliminar bloque">üóëÔ∏è</button>
        `;
        card.appendChild(header);

        card.appendChild(
          this.createFormGroup(
            'Subt√≠tulo (H3)',
            'text',
            block.subtitulo || '',
            (value) => this.updateSubtitle(sectionIndex, blockIndex, value),
            true
          )
        );

        card.appendChild(this.createParagraphsGroup(block.texto || [], sectionIndex, blockIndex));

        const addBlockBtn = document.createElement('button');
        addBlockBtn.className = 'btn btn-add';
        addBlockBtn.textContent = '+ A√±adir subt√≠tulo';
        addBlockBtn.onclick = () => this.addBlock(sectionIndex, blockIndex);
        card.appendChild(addBlockBtn);

        return card;
      },

      createParagraphsGroup(paragraphs, sectionIndex, blockIndex) {
        const group = document.createElement('div');
        group.className = 'form-group';
        const label = document.createElement('label');
        label.className = 'form-label';
        label.textContent = 'Texto (P√°rrafos)';
        group.appendChild(label);

        const list = document.createElement('div');
        list.className = 'paragraph-list';
        paragraphs.forEach((paragraph, pIndex) => {
          const item = this.createParagraphItem(paragraph, sectionIndex, blockIndex, pIndex);
          list.appendChild(item);
        });
        group.appendChild(list);

        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-add';
        addBtn.textContent = '+ A√±adir p√°rrafo';
        addBtn.onclick = () => this.addParagraph(sectionIndex, blockIndex);
        group.appendChild(addBtn);
        return group;
      },

      createParagraphItem(paragraph, sectionIndex, blockIndex, pIndex) {
        const item = document.createElement('div');
        item.className = 'paragraph-item';
        const header = document.createElement('div');
        header.className = 'paragraph-header';
        header.innerHTML = `
          <span class="paragraph-label">P√°rrafo ${pIndex + 1}</span>
          <button class="btn btn-icon btn-small" onclick="Editor.deleteParagraph(${sectionIndex}, ${blockIndex}, ${pIndex})" title="Eliminar p√°rrafo">üóëÔ∏è</button>
        `;
        item.appendChild(header);

        const textarea = document.createElement('textarea');
        textarea.className = 'form-textarea';
        textarea.value = paragraph;
        textarea.addEventListener('input', (e) => this.updateParagraph(sectionIndex, blockIndex, pIndex, e.target.value));
        item.appendChild(textarea);
        return item;
      },

      createLogosGroup(logos, sectionIndex) {
        const group = document.createElement('div');
        group.className = 'form-group';
        const label = document.createElement('label');
        label.className = 'form-label optional';
        label.textContent = 'Logos';
        group.appendChild(label);

        const list = document.createElement('div');
        list.className = 'logo-list';
        logos.forEach((logo, lIndex) => {
          const item = this.createLogoItem(logo, sectionIndex, lIndex);
          list.appendChild(item);
        });
        group.appendChild(list);

        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-add';
        addBtn.textContent = '+ A√±adir Logo';
        addBtn.onclick = () => this.addLogo(sectionIndex);
        group.appendChild(addBtn);
        return group;
      },

      createLogoItem(logo, sectionIndex, lIndex) {
        const item = document.createElement('div');
        item.className = 'logo-item';
        const header = document.createElement('div');
        header.className = 'logo-header';
        header.innerHTML = `
          <span class="logo-label">Logo ${lIndex + 1}</span>
          <button class="btn btn-icon btn-small" onclick="Editor.deleteLogo(${sectionIndex}, ${lIndex})" title="Eliminar logo">üóëÔ∏è</button>
        `;
        item.appendChild(header);

        const fields = document.createElement('div');
        fields.className = 'logo-fields';

        const srcInput = document.createElement('input');
        srcInput.className = 'form-input';
        srcInput.type = 'text';
        srcInput.placeholder = 'URL de la imagen (src)';
        srcInput.value = logo.src || '';
        srcInput.addEventListener('input', (e) => this.updateLogo(sectionIndex, lIndex, 'src', e.target.value));
        fields.appendChild(srcInput);

        const linkInput = document.createElement('input');
        linkInput.className = 'form-input';
        linkInput.type = 'text';
        linkInput.placeholder = 'URL del enlace (link)';
        linkInput.value = logo.link || '';
        linkInput.addEventListener('input', (e) => this.updateLogo(sectionIndex, lIndex, 'link', e.target.value));
        fields.appendChild(linkInput);

        const altInput = document.createElement('input');
        altInput.className = 'form-input';
        altInput.type = 'text';
        altInput.placeholder = 'Texto alternativo (alt)';
        altInput.value = logo.alt || '';
        altInput.addEventListener('input', (e) => this.updateLogo(sectionIndex, lIndex, 'alt', e.target.value));
        fields.appendChild(altInput);

        item.appendChild(fields);
        return item;
      },

      updateSection(index, field, value) {
        this.data[this.currentCategory][index][field] = value;
        this.triggerUpdate();
      },

      updateLogo(sectionIndex, lIndex, field, value) {
        if (!this.data[this.currentCategory][sectionIndex].logos) {
          this.data[this.currentCategory][sectionIndex].logos = [];
        }
        this.data[this.currentCategory][sectionIndex].logos[lIndex][field] = value;
        this.triggerUpdate();
      },

      normalizeBlocks(section) {
        if (!Array.isArray(section.bloques) || section.bloques.length === 0) {
          const subtitulo = typeof section.subtitulo === 'string' ? section.subtitulo : '';
          const texto = Array.isArray(section.texto) ? section.texto : [];
          section.bloques = [{ subtitulo, texto }];
          delete section.subtitulo;
          delete section.texto;
        }

        section.bloques = section.bloques.map(block => ({
          subtitulo: typeof block.subtitulo === 'string' ? block.subtitulo : '',
          texto: Array.isArray(block.texto) ? block.texto : []
        }));

        if (section.bloques.length === 0) {
          section.bloques.push({ subtitulo: '', texto: [] });
        }

        return section.bloques;
      },

      updateSubtitle(sectionIndex, blockIndex, value) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks[blockIndex].subtitulo = value;
        this.triggerUpdate();
      },

      updateParagraph(sectionIndex, blockIndex, pIndex, value) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks[blockIndex].texto[pIndex] = value;
        this.triggerUpdate();
      },

      addSection() {
        const newSection = { titulo: '', bloques: [{ subtitulo: '', texto: [] }] };
        this.data[this.currentCategory].push(newSection);
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      deleteSection(index) {
        if (confirm('¬øEst√°s seguro de que quieres eliminar esta secci√≥n?')) {
          this.data[this.currentCategory].splice(index, 1);
          this.renderCategory(this.currentCategory);
          this.triggerUpdate();
        }
      },

      moveSection(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= this.data[this.currentCategory].length) return;
        const sections = this.data[this.currentCategory];
        [sections[index], sections[newIndex]] = [sections[newIndex], sections[index]];
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      addBlock(sectionIndex, afterBlockIndex) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        const insertAt = Math.min(afterBlockIndex + 1, blocks.length);
        blocks.splice(insertAt, 0, { subtitulo: '', texto: [] });
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      deleteBlock(sectionIndex, blockIndex) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks.splice(blockIndex, 1);
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      addParagraph(sectionIndex, blockIndex) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks[blockIndex].texto.push('');
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      deleteParagraph(sectionIndex, blockIndex, pIndex) {
        const section = this.data[this.currentCategory][sectionIndex];
        const blocks = this.normalizeBlocks(section);
        blocks[blockIndex].texto.splice(pIndex, 1);
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      addLogo(sectionIndex) {
        if (!this.data[this.currentCategory][sectionIndex].logos) {
          this.data[this.currentCategory][sectionIndex].logos = [];
        }
        this.data[this.currentCategory][sectionIndex].logos.push({ src: '', link: '', alt: '' });
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      deleteLogo(sectionIndex, lIndex) {
        this.data[this.currentCategory][sectionIndex].logos.splice(lIndex, 1);
        this.renderCategory(this.currentCategory);
        this.triggerUpdate();
      },

      triggerUpdate() {
        if (window.Formatter && window.Formatter.onDataChange) window.Formatter.onDataChange();
      }
    };

    // ============================================================================
    // formatter.js (embebido)
    // ============================================================================
    const Formatter = {
      currentCategory: 'about',
      data: null,
      statusTimer: null,

      async init() {
        const stored = Storage.load();
        let repoData = null;
        if (!stored) this.showStatus('Cargando data.json del repo...', '');

        try {
          repoData = await Storage.fetchFromRepo();
        } catch (error) {
          console.error('No se pudo leer data.json del repo', error);
          this.showStatus('No se pudo leer data.json del repo', 'error');
        }

        this.data = this.normalizeData(stored) || this.normalizeData(repoData) || Storage.getEmptyStructure();

        Editor.init(this.data);
        Preview.init();
        this.setupEventListeners();
        this.switchCategory(this.currentCategory);
        this.updateCounts();

        if (stored) {
          this.showStatus('Datos recuperados del guardado local', 'success');
        } else if (repoData) {
          this.showStatus('data.json cargado autom√°ticamente', 'success');
          Storage.save(this.data);
        } else {
          this.showStatus('Arrancamos con un esquema vac√≠o', 'warning');
        }
      },

      normalizeData(raw) {
        return Storage.normalize(raw);
      },

      setupEventListeners() {
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const category = e.currentTarget.dataset.category;
            this.switchCategory(category);
          });
        });

        document.getElementById('addSectionBtn').addEventListener('click', () => {
          Editor.addSection();
          this.updateCounts();
        });

        document.getElementById('saveBtn').addEventListener('click', () => this.saveProgress());
        document.getElementById('downloadBtn').addEventListener('click', () => this.downloadData());

        const copyBtn = document.getElementById('copyJsonBtn');
        if (copyBtn) copyBtn.addEventListener('click', () => this.copyJson());
      },

      switchCategory(category) {
        this.currentCategory = category;
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.category === category);
        });

        const categoryTitles = { about: 'About', booking: 'Booking', cv: 'CV' };
        document.getElementById('categoryTitle').textContent = categoryTitles[category] || category;

        if (!this.data[category]) this.data[category] = [];
        Editor.renderCategory(category);
        Preview.render(this.data[category]);
      },

      updateCounts() {
        ['about', 'booking', 'cv'].forEach(category => {
          const count = this.data[category] ? this.data[category].length : 0;
          const countEl = document.getElementById(`count-${category}`);
          if (countEl) countEl.textContent = count;
        });
      },

      onDataChange() {
        Preview.render(this.data[this.currentCategory]);
        this.updateCounts();
        Storage.save(this.data);
      },

      saveProgress() {
        const success = Storage.save(this.data);
        this.showStatus(success ? 'Progreso guardado en este navegador' : 'No se pudo guardar el progreso', success ? 'success' : 'error');
      },

      downloadData() {
        const success = Storage.export(this.data, 'data.json');
        this.showStatus(success ? 'Descarga lista' : 'No se pudo generar el JSON', success ? 'success' : 'error');
      },

      async copyJson() {
        const success = await Storage.copyToClipboard(this.data);
        this.showStatus(success ? 'JSON copiado al portapapeles' : 'No se pudo copiar el JSON', success ? 'success' : 'error');
      },

      resetData() {
        if (confirm('¬øQuieres volver al data.json limpio? Se perder√°n los cambios sin guardar.')) {
          this.data = Storage.getEmptyStructure();
          Editor.data = this.data;
          Storage.clear();
          this.switchCategory(this.currentCategory);
          this.updateCounts();
          this.showStatus('Contenido reseteado', 'success');
        }
      },

      showStatus(message, type = '') {
        const statusEl = document.getElementById('statusMessage');
        if (!statusEl) return;
        statusEl.textContent = message;
        statusEl.className = 'status-message ' + type;
        clearTimeout(this.statusTimer);
        this.statusTimer = setTimeout(() => {
          statusEl.textContent = '';
          statusEl.className = 'status-message';
        }, 3200);
      }
    };

    document.addEventListener('DOMContentLoaded', () => Formatter.init());
  </script>
</body>
</html>
